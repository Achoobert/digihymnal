<template>
    <div class="page">
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">{{#if loading}}Back{{else}}{{translate "Back"}}{{/if}}</span>
                    </a>
                </div>
                <div class="title">{{#if loading}}{{else}} {{song.title[defaultLanguage]}} : {{@root.verseLabel}} {{/if}}</div>
            </div>
        </div>
        <div class="page-content hide-navbar-on-scroll">
            {{#js_if "!@root.loading"}}
                <div class="block block-strong" style="margin-bottom: 10px; overflow: hidden;">
                    <div class="menu">
                        <div class="menu-inner no-margin-padding">
                            <!-- Stepper element -->
                            <div class="stepper stepper-large stepper-fill" style="display: none; margin-left: auto; height: 40px;">
                                <div class="stepper-button-minus"></div>
                                <div class="stepper-input-wrap">
                                    <input type="text" value="{{transpose song.key @root.steps}}" readonly>
                                </div>
                                <div class="stepper-button-plus"></div>
                            </div>
                            <div>
                            <div class="menu-item">
                              <div class="menu-item-content icon-only">
                                <div class="menu-item-content">
                                    <a @click="save" class="col button button-fill">
                                        <i class="text-color-gray fa-bigger fas fa-save"></i>
                                    </a>
                                </div>
                              </div>
                            </div>
                            </div>
                            <div class="menu-item">
                              <div class="menu-item-content icon-only">
                                  <div class="menu-item-content">
                                      <a class="col button button-fill{{#if firstLine}} disabled"{{else}}" @click="prevLine"{{/if}} >
                                          <i class="text-color-gray fas fa-bigger fa-arrow-left"></i>
                                      </a>
                                  </div>
                              </div>
                            </div>
                          {{#js_if "@root.lastLine && @root.lastVerse"}}
                            <!--  
                              goto next verse
                            -->
                            <div class="menu-item">
                              <div class="menu-item-content icon-only">
                                  <div class="menu-item-content">
                                      <a class="col button button-fill disable disabled" disable>
                                          <i class="text-color-gray fa-bigger fas fa-arrow-right"></i>
                                      </a>
                                  </div>
                              </div>
                            </div>
                            <div class="item-title item-label">
                              <t>Verse tools:</t>
                            </div>
                            <!-- ADD VERSE -->
                            <div class="menu-item">
                              <div class="menu-item-content icon-only">
                                  <div class="menu-item-content">
                                      <a @click="addVerse" class="col button button-fill">
                                          <i class="text-color-gray fa-bigger fas fa-plus"></i>
                                      </a>
                                  </div>
                              </div>
                            </div>
                            <div class="item-title item-label">
                              <t>Line tools:</t>
                            </div>
                            <!-- ADD LINE -->
                              <div class="menu-item">
                                <div class="menu-item-content icon-only">
                                    <div class="menu-item-content">
                                        <a @click="addLine" class="col button button-fill">
                                            <i class="text-color-gray fa-bigger fas fa-plus"></i>
                                        </a>
                                    </div>
                                </div>
                              </div>
                            
                          {{else}}
                            {{#if lastLine}}
                            <!--
                              goto next verse
                            -->
                              <div class="menu-item">
                                <div class="menu-item-content icon-only">
                                    <div class="menu-item-content">
                                        <a @click="nextLine" class="col button button-fill">
                                            <i class="text-color-gray fa-bigger fas fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                              </div> 
                              <div class="item-title item-label">
                                <t>Line tools:</t>
                              </div> 
                              <!--
                              ADD LINE
                              -->
                              <div class="menu-item">
                                <div class="menu-item-content icon-only">
                                    <div class="menu-item-content">
                                        <a @click="addLine" class="col button button-fill">
                                            <i class="text-color-gray fa-bigger fas fa-plus"></i>
                                        </a>
                                    </div>
                                </div>
                              </div>
                            {{else}}
                              <div class="menu-item">
                                <div class="menu-item-content icon-only">
                                    <div class="menu-item-content">
                                        <a @click="nextLine" class="col button button-fill">
                                            <i class="text-color-gray fa-bigger fas fa-arrow-right"></i>
                                        </a>
                                    </div>
                                </div>
                              </div>
                              <div class="item-title item-label">
                                <t>Line tools:</t>
                              </div>
                            {{/if}}
                          {{/js_if}}
                            
                            <div class="menu-item">
                              <div class="menu-item-content icon-only">
                                  <div class="menu-item-content">
                                      <a class="col button button-fill" @click="deleteLine">
                                          <i class="text-color-gray fa-bigger fas fa-trash"></i>
                                      </a>
                                  </div>
                              </div>
                            </div>
                            <div class="item-title item-label">
                              Phrase tools:
                            </div>
                            <!--
                              Add phrase
                            -->
                            <div class="menu-item">
                              <div class="menu-item-content icon-only">
                                  <div class="menu-item-content">
                                      <a @click="addPhrase" class="col button button-fill">
                                          <i class="text-color-gray fas fa-plus"></i>
                                      </a>
                                  </div>
                              </div>
                            </div>
                            <!--
                              delete phrase, only show if totally empty??????
                            -->
                            <div class="menu-item">
                              <div class="menu-item-content icon-only">
                                  <div class="menu-item-content">
                                      <a @click="deletePhrase" class="col button button-fill">
                                          <i class="text-color-gray fas fa-trash"></i>
                                      </a>
                                  </div>
                              </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sheet">
                        <div class="song">
                            <!-- -->
                            <div style="padding: 50px">
                              <div id="slider" class="slider"></div>
                            </div>
                            <!-- -->
                            <div class="verse">
                              <div class="line">
                                {{ printLyric @root.line}}
                              </div>
                            </div>
                          </div>
                    </div>
                    <!-- <div class="sheet">
                      <div class="song">
                        <div class="verse">
                          {{#if label}}<h3>{{label}}</h3>{{/if}}
                          <div class="line" id="edit-line">
                            {{ printEachPhrase @root.line @root.languages }}
                          </div>
                        </div>
                      </div>
                    </div> -->
                  </div>
                <div class="block text-align-right text-color-gray" style="margin-top: 10px;">
                    {{song.author[defaultLanguage]}}
                </div>
            {{/js_if}}
        </div>
    </div>
</template>
<style>
    .noUi-marker {
      height: 0 !important;
    } 
    .no-margin-padding {
        margin: 0;
        padding: 0;
    }

    .fa-bigger {
        font-size: larger;
    }

    .song {
        transform-origin: left top;
    }

    .line {
        margin-bottom: 20px;
    }

    .phrase {
        position: relative;
        display: inline-block;
        margin: 55px 10px 0 0;
        min-width: 20px;
    }

    .chord,
    .number {
        top: -55px;
        background: var(--f7-theme-color);
        border-radius: 3px;
        min-width: 20px;
        height: 20px;
        line-height: 20px;
        text-align: center;
        color: white;
        font-weight: bold;
        display: inline-block;
        padding: 0 2px;
        margin-right: 5px;
        position: absolute;
        padding: 2px;
    }

    .number {
        top: -25px;
        border-radius: 100%;
        width: 20px;
        height: 20px;
        padding: 2px;
        background: var(--f7-color-blue);
        font-family: 'Notes', monospace;
    }

    .noNumbers,
    .noChords {
        margin-top: 30px !important;
    }

    .noNumbers.noChords {
        margin-top: 10px !important;
    }

    .noNumbers .chord,
    .noChords .chord {
        top: -30px;
    }
    
</style>
<script>
  var songId
  var loading
  var verseId
  var verseLabel
  var lineId
  var languages
  var lyricList
  var line
  var song
  var app
  var lastVerse
  var lastLine
  var firstLine
  import DataManager from '../data/dataManager';
  import Song from '../data/song';
  import noUiSlider from 'nouislider';
  import 'nouislider/dist/nouislider.css';
// //  the namespace:
// import * as noUiSlider from 'nouislider';
// import 'nouislider/dist/nouislider.css';

// // Alternatively, you can include both files:
// <link href="nouislider.css" rel="stylesheet">
// <script src="nouislider.js"><//////script>

  import Preference from "../data/preference";
  const dataManager = new DataManager();
  const songCollection = new Song();
  const preference = new Preference();
  
  // Import locales
  const locale = require('../js/locales.js');

  var initScale = 1;
  var lyric1;
  var lyric2;
  var defaultLanguage;
  var deviceWidth = window.innerWidth;
  var self = this;
  if (deviceWidth >= 700) {
    initScale = 2;
  } else if (deviceWidth >= 500) {
    initScale = 1.5;
  }
  var steps = 0;

  export default {
    // Component Data
    data: function () {
      // Must return an object
      self = this;
      return {
        loading: true,
        lastVerse: false,
        lastLine: false,
        firstLine: false,
        showNumber: false,
        showChord: false
      }
    },
    // Page Events
    on: {
      pageInit: function(e, page) {
        self = this;
        app = self.$app;
        var $form = this.$('#edit-line')

        songId = this.$route.params.songId;
        // console.log(songId)
        verseId = this.$route.params.verseId;
        // console.log(verseId)
        lineId = this.$route.params.lineId;
        // console.log(lineId)

        preference.getLanguage().then((languageCode) => {
          lyric1 = languageCode;
          defaultLanguage = languageCode;
          console.log('current lang: ' + lyric1);
          songCollection.get(songId).then(result => {
            languages = [];
            lyricList = []
            var translationLangs = Object.keys(result.title);
            locale.customLocales.forEach((item) => {
              if (translationLangs.indexOf(item.tag) > -1) {
                if (item.tag == lyric1) {
                  item.default = true;
                }
                languages.push(item.tag)
              }
            });
            line = result.lyrics.verses[verseId].lines[lineId]
            console.log(line)

            // check if last line
            lastLine = (lineId>=(result.lyrics.verses[verseId].lines.length-1));
            lastVerse = (verseId>=(result.lyrics.verses.length-1));
            // song is used to get next line
            song = result

            
            self.$setState({
              loading: false,
              songId: songId,
              lastLine: lastLine,
              lastVerse: lastVerse,
              verseLabel : result.lyrics.verses[verseId].label,
              firstLine: (lineId == 0 && verseId == 0),
              song: result,
              // verse: result.verse[verseId],
              line: line,
              steps: steps,
              languages: languages,
              lyricList: lyricList,
              defaultLanguage: defaultLanguage
            }, () => {
              self.$(".song")[0].style.transform = "scale("+initScale+")";
              self.$(".sheet")[0].style.height = (self.$(".song")[0].offsetHeight * initScale) + "px";
              
              // a. make invisible lyric string. knobs align to divs associated with each letter
              // b. get average size of each character, get count of space-taking characters (ignore diacritics). Total length of slider is that length, steps is that total
              // c. highlited text-cursor
              // d. find px width of each character. Ignore 0 width.
              //   // example: [('index':0,'pxwidth':3),('index':1,'pxwidth':2),('index':0,'pxwidth':4),]
              // then make stepper match that
              //   // [(0, width:3),(1, width:2),(2, width:4),]
              //   //  I...I..I....I..
              var lyric = {}
              lyric.arr = {}
              
              line.phrases.forEach(phrase => {
                for (const key in phrase) {
                  if (Object.hasOwnProperty.call(phrase, key)) {
                    const element = phrase[key];
                    if(lyric[key]){
                      lyric[key] = lyric[key].concat(element)
                    } else {
                      lyric[key] = element
                    }
                  }
                }
              });  
              //
              var pipFormatter = {};
              //var pipFormats = {'0':'abc', '1':'pqr', '2':'xyz'};
              var range = {};
              // {min/max/percentage: [increment, 1]}

              for (const tag in lyric) {
                pipFormatter[tag] = {};
                range[tag] = {};   
                if (Object.hasOwnProperty.call(lyric, tag)) {
                  const element = lyric[tag];
                  if(typeof(element)=='string'){
                    console.log(element)
                    //array
                    var langArray = lyric[tag].split("");
                    lyric.arr[tag] = lyric[tag].split("");

                    let totalCharacters = langArray.length;
                    let increment = (Math.floor((100/totalCharacters)* 10) )/10
                    var i = 0;
                    // pipFormatter = {'min': [0,increment]}
                    range[tag]['min'] = [0,1];
                    while (i<totalCharacters){
                      // {('0':'abc')}
                      let currentChar = langArray[i]; // get char from position 0, insert to position 1
                      pipFormatter[tag][i.toString()] = currentChar;

                      // range
                      // {'50%': [1,1]}
                      let currentPlace = (increment*i)  // starts at 0
                      let nextPlace = (increment*(++i))
                      range[tag][`${nextPlace}%`] = [i,1];
                    };
                    pipFormatter[tag][i.toString()] = " ";
                    range[tag]['max'] = [i,1];
                    makeSlider( tag, pipFormatter[tag], range[tag] )
                  }
                }
              };
            
              function makeSlider(tag, pipFormats, lyricRange){ // TODO start
                //  Make the slider
                //var skipSlider = self.$(".skipSlider")[0]//document.getElementById('nonlinear');
                var slider = self.$(`.slider-${tag}`)[0];

                noUiSlider.create(slider, {
                  start: [0,4],
                  tooltips: [
                    {
                      to: function() {
                        return "2<br/>A";
                      }
                    },
                    {
                      to: function() {
                        return "3<br/>G";
                      }
                    }
                  ],
                  range: lyricRange,
                  pips: {
                    mode: 'range',
                    format: {
                      to: function(a) {
                        return pipFormats[a];
                      }
                    }
                  }
                });
              }
              ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
              console.log (lyric)
              //  Make the slider
              console.log(line)
              debugger
              //var skipSlider = self.$(".skipSlider")[0]//document.getElementById('nonlinear');
              var slider = self.$(".slideren")[0];
              var pipFormats = {'0':'H', 
                                '1':'e', 
                                '2':'y',
                                '3':' ',
                                '4':'D',
                                '5':'u',
                                '6':'d',
                                '7':'e'};

              noUiSlider.create(slider, {
                start: [0,4],
                tooltips: [
                  {
                    to: function() {
                      return "2<br/>A";
                    }
                  },
                  {
                    to: function() {
                      return "3<br/>G";
                    }
                  }
                ],
                range: {
                  min: [0,1],
                  "5%": [1,1],
                  "10%": [2,1],
                  "15%": [3,1],
                  "56.8%": [4,1],
                  "71%": [5,1],
                  "85%": [6,1],
                  max: [7]
                },
                pips: {
                  mode: 'range',
                  format: {
                    to: function(a) {
                      return pipFormats[a];
                    }
                  }
                }
              });
              //

              languages.forEach(lang => {
                console.log(lang.tag)
                line.phrases.forEach(phrase => {
                  console.log(phrase[lang.tag])
                  lyricList.push({"tag":lang.tag,"lyric":line[lang.tag]})
                });
              });
              console.log(result.lyrics.verses[verseId].lines[lineId])

              var stepper = app.stepper.create({
                el: '.stepper',
                value: steps,
                min: 0,
                max: 11,
                wraps: true,
                on: {
                  change: function (e) {
                    steps = e.value;
                    self.$setState({
                      steps: steps,
                    });
                  }
                }
              });
            });
          });
        });
      },
    },
    methods: {
      zoomIn: function(e) {
        initScale += 0.05;
        this.$(".song")[0].style.transform = "scale("+initScale+")";
        this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
      },
      zoomOut: function(e) {
        initScale -= 0.05;
        this.$(".song")[0].style.transform = "scale("+initScale+")";
        this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
      },
      toggleChords: function(e) {
        if (this.$(".menuChords .fa-check-square")[0].style.display == "") {
          this.$setState({
            showChord: false
          });
          this.$(".menuChords .fa-square")[0].style.display = "";
          this.$(".menuChords .fa-check-square")[0].style.display = "none";
          this.$(".phrase").addClass("noChords");
          this.$(".stepper")[0].style.display = "none";
          this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
        } else {
          this.$setState({
            showChord: true
          });
          this.$(".menuChords .fa-check-square")[0].style.display = "";
          this.$(".menuChords .fa-square")[0].style.display = "none";
          this.$(".phrase").removeClass("noChords");
          this.$(".stepper")[0].style.display = "";
          this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
        }
      },
      toggleNumbers: function(e) {
        if (this.$(".menuNumbers .fa-check-circle")[0].style.display == "") {
          this.$setState({
            showNumber: false
          });
          this.$(".menuNumbers .fa-circle")[0].style.display = "";
          this.$(".menuNumbers .fa-check-circle")[0].style.display = "none";
          this.$(".phrase").addClass("noNumbers");
          this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
        } else {
          this.$setState({
            showNumber: true
          });
          this.$(".menuNumbers .fa-check-circle")[0].style.display = "";
          this.$(".menuNumbers .fa-circle")[0].style.display = "none";
          this.$(".phrase").removeClass("noNumbers");
          this.$(".sheet")[0].style.height = (this.$(".song")[0].offsetHeight * initScale) + "px";
        }
      },
      save: function(e) {
        console.log(songId,verseId,lineId)
        var $form = this.$('#edit-line')
        var $ = $form.find("select[name='']") //relation
        if (!self.$app.input.validateInputs('#edit-line')) {
          // TODO make this say what the error is
          self.$app.dialog.alert('Please correct your entries.');
          console.error('<t>Please correct your entries.</t>');
        } else {

        
        songCollection.get(songId).then(result => {
          // 
          let newData = result
          // newData.lyrics.verses[verseId].lines[lineId].phrases[0][languageCode] = "THIS HAS BEEN SET BY CLICKING THE BUTTON"
          newData.lyrics.verses[verseId].lines[lineId].phrases
          
          // get data from the dom
          var listOfLines = Array.from(this.$('#edit-line')[0].children)
          // iterate horizontally
          // each chord, number, and language
          listOfLines.forEach(lineElement => {
            var tag = ""
            // find out what the tag is
            if(lineElement.classList.value.includes("metadata")){
              // is chords/nums, both chords and nums are in same place in dom.
              // chords = _this.$('#edit-line')[0].children[0].children[X].children[0].children[0].children[0].value
              // number = _this.$('#edit-line')[0].children[0].children[X].children[1].children[0].children[0].value
              tag = 'metadata'
            } else {
              // at, kt etc...
              tag = lineElement.classList.value
            }
            // now, we have "chords": ['a','b','c']
            let elementChildrenArray = Array.from(lineElement.children)

            // elementChildrenArray.forEach(phraseElement=> { 
            //   // this gives us '1'
            //   console.log(phraseElement.children[1].children[0].children[0].value)
            // });

            // look into phrase at similar index
            var i = 0
            while (i < elementChildrenArray.length) {
              if(tag === "metadata"){
                // ----------------------------------------- Special phrase-metaData setter ------------------------------------------------------------- //
                // split it....
                // setting chord
                console.log(elementChildrenArray[i].children[0].children[0].children[0].value)
                newData.lyrics.verses[verseId].lines[lineId].phrases[i]['chord'] = elementChildrenArray[i].children[0].children[0].children[0].value
                // setting number
                console.log(elementChildrenArray[i].children[1].children[0].children[0].value)
                newData.lyrics.verses[verseId].lines[lineId].phrases[i]['number'] = elementChildrenArray[i].children[1].children[0].children[0].value
                // -------------------------------------------------------------------------------------------------------------------------------------- //
              } else {
                console.log(elementChildrenArray[i].children[1].children[0].children[0].value) // needs to skip the first element
                // update song to match
                newData.lyrics.verses[verseId].lines[lineId].phrases[i][tag] = elementChildrenArray[i].children[1].children[0].children[0].value//.trim()
              }
              i++;
            }    
          });
          // save
          songCollection.db.setItem(songId, newData)
          self.$setState({
            loading: false,
            song: newData,
          });
          // send line changes to server
          dataManager.putLine(songId,verseId,lineId,newData.lyrics.verses[verseId].lines[lineId])
            .then(responseText => alert(JSON.stringify(responseText))); 
        }); 
      }
  },
      nextLine: function(e) {
        // only get index forward if it exists in song
        //debugger
        console.log(lastVerse)
        if(lastLine && !lastVerse){ // if at end of NOTlastVerse, check next verse
          lastVerse = ((verseId+1) >= (song.lyrics.verses.length-1)); // is next verse last verse?
          lastLine = ((song.lyrics.verses[parseInt(verseId)+1].lines[1]) == undefined); // is there only one line in next verse?
          ++verseId;
          lineId = 0;
          verseLabel = song.lyrics.verses[verseId].label;
        } else {
          // check if last line
          lastLine = ((lineId+1) >= (song.lyrics.verses[verseId].lines.length-1));
          ++lineId;
        }
        
        



        // update variable
        self.$setState({
          loading: false,
          firstLine: (lineId == 0 && verseId == 0),
          lastLine: lastLine,
          lastVerse: lastVerse,
          verseLabel: verseLabel,
          line: song.lyrics.verses[verseId].lines[lineId]
        }, () => {
          console.log(song.lyrics.verses[verseId].lines[lineId])
        });
      },
      prevLine: function(e) {
        if(lineId == 0){
          --verseId
          lineId = song.lyrics.verses[verseId].lines.length-1
          // update variable
          lastVerse = ((verseId) >= (song.lyrics.verses.length-1)); // is next verse last verse?
          verseLabel = song.lyrics.verses[verseId].label;
        }else{
          --lineId
        }

        self.$setState({
          loading: false,
          firstLine: (lineId == 0 && verseId == 0),
          lastLine: false,
          verseLabel: verseLabel,
          lastVerse: lastVerse,
          line: song.lyrics.verses[verseId].lines[lineId]
        }, () => {
          console.log(song.lyrics.verses[verseId].lines[lineId])
        });
      },
      deleteLine: function(e) {
        console.log(songId,verseId,lineId);
        // TODO pre-delete confirmation prompt
        songCollection.get(songId).then(result => {
          let newData = result
          // At index, remove one element
          let deletedLine = newData.lyrics.verses[verseId].lines.splice(lineId, 1)

          // default to changing nothing, wil auto set to the right line
          // debugger
          if ((verseId != 0) && lineId == 0 && (0 == newData.lyrics.verses[verseId].lines.length)){
            // if last remaining line of not last verse
            let deletedVerse = newData.lyrics.verses.splice(verseId, 1)
            if(lastVerse){
              --verseId;
            }
            lineId = newData.lyrics.verses[verseId].lines.length-1;
          }else if (lastLine){
            // set lineId to an existing line
            --lineId;
          } else {
            console.error("You tried to delete the last line of the last verse!!!")
          }

          songCollection.db.setItem(songId, newData)
          song = newData;

          self.$setState({
            line: newData.lyrics.verses[verseId].lines[lineId],
            firstLine: (lineId == 0 && verseId == 0),
            lastLine: (lineId>=(song.lyrics.verses[verseId].lines.length-1)),
            song: newData,
            loading: false,
          });
        });
      },
      addVerse: function(e) {
        console.log(songId,verseId,lineId);
        songCollection.get(songId).then(result => {
          let newData = result;
          var phraseTemplate = Object.assign({}, newData.lyrics.verses[verseId].lines[lineId].phrases[0]);
          for (const tag in phraseTemplate) {
            if (Object.hasOwnProperty.call(phraseTemplate, tag)) {
              // set all data inside empty
              phraseTemplate[tag] = "*"
            }
          };
          var lineObj = {"lines":[{'phrases':[phraseTemplate]}]}; // make a new template
          
          var currentVerse = newData.lyrics.verses[verseId];
          
          var newId = ((parseInt(currentVerse.id)!== NaN) ? (parseInt(currentVerse.id)+1) : 1);

          // 'verse 3'
          let myArr = currentVerse.label.split(" ");
          let verseNumber = (typeof(parseInt(myArr[(myArr.length-1)])) == 'number'  ? (parseInt(myArr[(myArr.length-1)])) : 1 )

          var newLabel =  'verse'.concat(verseNumber);
          console.log(newLabel)

          var newVerse  = {
            "lines": lineObj,
            "label": newLabel,
            "id": newId
          }

          newData.lyrics.verses.push(newVerse);
          console.log(newData)
          songCollection.db.setItem(songId, newData);

          // send ovreall song changes to server
          dataManager.putSong(songId,newData)
            .then(responseText => alert(JSON.stringify(responseText))); 
          lastLine = true;
          self.$setState({
            loading: false,
            song: newData,
            lastLine: true,
            line: newData.lyrics.verses[verseId+1].lines[0]
          }, () => {
            console.log(newData.lyrics.verses[verseId].lines[lineId]);
            // TODO reload previous song page
          });
        });
      },
      addLine: function(e) {
        console.log(songId,verseId,lineId);
        songCollection.get(songId).then(result => {
          let newData = result;
          // At index, add one element
          
          //var phraseTemplate = newData.lyrics.verses[verseId].lines[lineId].phrases[0];
          //var phraseTemplate = {};
          var phraseTemplate = Object.assign({}, newData.lyrics.verses[verseId].lines[lineId].phrases[0]);

          for (const tag in phraseTemplate) {
            if (Object.hasOwnProperty.call(phraseTemplate, tag)) {
              // set all data inside empty
              phraseTemplate[tag] = "*"
            }
          };

          var lineArray = newData.lyrics.verses[verseId].lines;
          var workingIndex = lineArray.length-1; // tack it onto the end
          lineArray.push({'phrases':[phraseTemplate]}); // extend by copying the last
          workingIndex += 1;
          
          newData.lyrics.verses[verseId].lines = lineArray;
          console.log(newData);
          songCollection.db.setItem(songId, newData);

          // send verse changes to server
          dataManager.putVerse(songId,verseId,newData.lyrics.verses[verseId])
            .then(responseText => alert(JSON.stringify(responseText))); 
          // lastLine = (lineId===(newData.lyrics.verses[verseId].lines.length-1))
          self.$setState({
            loading: false,
            song: newData,
            line: newData.lyrics.verses[verseId].lines[workingIndex]
          }, () => {
            console.log(newData.lyrics.verses[verseId].lines[lineId]);
            // TODO reload previous song page
          });
        });
      },
      addPhrase: function(e) {
        console.log(songId,verseId,lineId);
        songCollection.get(songId).then(result => {
          let newData = result
          // At index, add one element
          
          var phraseArray = newData.lyrics.verses[verseId].lines[lineId].phrases
          var workingIndex = phraseArray.length-1;
          phraseArray.push({ ...phraseArray[workingIndex] }); // extend by copying the last
          workingIndex = phraseArray.length-1;

          for (const tag in phraseArray[workingIndex]) {
            if (Object.hasOwnProperty.call(phraseArray[workingIndex], tag)) {
              // set all data inside empty
              phraseArray[workingIndex][tag] = "*"
            }
          }

          console.log(phraseArray);

          newData.lyrics.verses[verseId].lines[lineId].phrases = phraseArray
          songCollection.db.setItem(songId, newData)


          self.$setState({
            loading: false,
            song: newData,
            line: newData.lyrics.verses[verseId].lines[lineId]
          }, () => {
            console.log(newData.lyrics.verses[verseId].lines[lineId]);
            // TODO reload previous song page
          });
          // TODO update IS CHANGED variable
        });
      },
      deletePhrase: function(e) {
        console.log(songId,verseId,lineId);
        songCollection.get(songId).then(result => {
          let newData = result

          var workingIndex = (newData.lyrics.verses[verseId].lines[lineId].phrases).length-1;
          let deletedPhrase = newData.lyrics.verses[verseId].lines[lineId].phrases.splice(workingIndex, 1)
          console.log({"removing" : deletedPhrase }) 
          songCollection.db.setItem(songId, newData)

          self.$setState({
            loading: false,
            song: newData,
            line: newData.lyrics.verses[verseId].lines[lineId]
          }, () => {
            console.log(newData.lyrics.verses[verseId].lines[lineId]);
            // TODO reload previous song page
          });
        });
      }
    }
  }
</script>