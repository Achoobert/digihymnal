<template>
    <div class="page" data-name="home">
        <!-- Top Navbar -->
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
                <div class="title sliding">{{#if loading}}Digital Hymnal{{else}}{{translate "Digital Hymnal"}}{{/if}}</div>
                <div class="right">
                    <a href="/settings/" class="link icon-only">
                        <span class="fa-stack">
                            <i class="fas fa-circle fa-stack-2x"></i>
                            <i style="margin-left: 0;" class="fas fa-language fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </div>
                <div class="title-large">
                    <div class="title-large-text">{{#if loading}}Digital Hymnal{{else}}{{translate "Digital Hymnal"}}{{/if}}</div>
                </div>
                <div class="subnavbar">
                    <!-- Searchbar with auto init -->
                    <form class="searchbar">
                        <div class="searchbar-inner">
                            <div class="searchbar-input-wrap">
                                <input type="search" placeholder='{{#if loading}}Search{{else}}{{translate "Search"}}{{/if}}'>
                                <i class="searchbar-icon"></i>
                                <span class="input-clear-button"></span>
                            </div>
                            <span class="searchbar-disable-button if-not-aurora">{{#if loading}}Cancel{{else}}{{translate "Cancel"}}{{/if}}</span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Scrollable page content-->
        <div class="page-content">
            <div class="searchbar-backdrop"></div>
            <div class="block searchbar-not-found">
                <div class="block-inner">Nothing found</div>
            </div>
            <div class="list media-list searchbar-found">
                <ul>
                    {{#if loading}}
                        {{#each "1234567890"}}
                            <li class="skeleton-text skeleton-effect-fade">
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title-row">
                                            <div class="item-title">Song Name will go Here</div>
                                        </div>
                                        <div class="item-subtitle text-color-gray">Credit Here</div>
                                    </div>
                                </div>
                            </li>
                        {{/each}}
                    {{else}}
                        {{#each songs}}
                            {{#if this.song}}
                            <!--this is where we filter the songs to the language-->
                            {{#js_if "Object.hasOwnProperty.call(this.song.title, @root.locale)"}}
                                <li>
                                    <a href="/song/view/{{this.id}}/" class="item-link">
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <div class="item-title-row">
                                                    <div class="item-title">{{ printObjectPropertyByKey this.song.title @root.locale }}</div>
                                                </div>
                                                <div class="item-subtitle text-color-gray">{{this.song.author}}</div>
                                            </div>
                                        </div>
                                    </a>
                                </li>
                            {{/js_if}}
                            {{/if}}
                        {{/each}}
                    {{/if}}
                </ul>
            </div>
        </div>
    </div>
</template>
<script>
import Preference from "../data/preference";
//////
import Song from '../data/song';
import DataManager from '../data/dataManager';

const preference = new Preference();
const songCollection = new Song();
const dataManager = new DataManager();


var locale = 'kt';
var languageCode = 'kt';
var app;
var http = new XMLHttpRequest();
export default {

  data: function () {
    return {
      loading: true
    }
  },
  on: {

    pageInit: function(e, page) {
      var self = this;
      app = self.$app;

      dataManager.getSong('2').then(json => {
        console.log(json)
      });


      // get the full list of songs from the server, 
      // then send to the localforage-init area
      dataManager.getSongs().then( songData => {
        console.log(songData);
        songCollection.initSample(songData);
        preference.getLanguage().then((languageCode) => {
          locale = languageCode;
          console.log(locale)
          window.languageCode = locale;
          console.log(songData);
          self.$setState({ loading: false, songs: songData, locale: languageCode });
        });

      })
      

      // create searchbar
      var searchbar = app.searchbar.create({
        el: '.searchbar',
        searchContainer: '.list',
        searchIn: '.item-title, .item-subtitle',
        on: {
          search(sb, query, previousQuery) {
            console.log(query, previousQuery);
          }
        }
      });
    }
  }
}
</script>